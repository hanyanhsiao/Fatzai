<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Car</title>
    <link rel="stylesheet" href="./css/common/all.css" />
    <link rel="stylesheet" href="./css/common/common.css">
    <link rel="stylesheet" href="./css/car.css" />
    <link rel="stylesheet" href="./css/rwd.css">
    <!--引入font-awesome icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
        integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<body>
    <header class="header"></header>

    <main>
        <div class="wrapper">
            <div class="process">
                <div class="step">
                    <span class="badge badge1">
                        <!-- before -->
                        <span class="text">1</span>
                        <!-- after -->
                    </span>
                    <span>購物車</span>
                </div>
                <div class="step">
                    <span class="badge badge2">
                        <!-- before -->
                        <span class="text">2</span>
                        <!-- after -->
                    </span>
                    <span>填寫資料</span>
                </div>
                <div class="step">
                    <span class="badge badge3">
                        <!-- before -->
                        <span class="text">3</span>
                        <!-- after -->
                    </span>
                    <span>確認訂單</span>
                </div>
                <div class="step">
                    <span class="badge badge4">
                        <!-- before -->
                        <span class="text">4</span>
                        <!-- after -->
                    </span>
                    <span>確認付款</span>
                </div>


            </div>
            <!-- --------購物車----------->
            <div class="car">
                <p>購物車</p>

                <!-- ---標題-- -->
                <ul class="car_title">
                    <li>商品</li>
                    <li>名稱</li>
                    <li>規格</li>
                    <li>金額</li>
                    <li>數量</li>
                    <li>合計</li>
                    <li>刪除</li>
                </ul>
                <!-- 購買商品 -->
                <div class="car_item_block">
                    <!-- <ul class="car_item">
                        <li> <a href="./item.html"><img src="./image/items/tart (1).jpg" alt=""></a></li>
                        <li>提拉米蘇塔</li>
                        <li>圓塔</li>
                        <li>$199</li>
                        <li>2</li>
                        <li>$398</li>
                        <li><i class="fa-regular fa-circle-xmark"></i></li>
                        <li class="addit delete" style="background-color: black; color: white;">刪除</li>//手機板
                    </ul> -->
                </div>

            </div>
            <!-- 加購區 -->
            <div class="more">
                <p>限量加購</p>
                <ul class="more_items">
                    <li>
                        <img src="./image/material/candles.jpg">
                        <h3 class="item_name">數字蠟燭組</h3>
                        <h3 class="item_id">(任選兩支)</h3>
                        $<p class="dollars">50</p>
                        <button class="moreItem_addCart">
                            <p>加入購物車</p>
                            <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>
                            <lord-icon src="https://cdn.lordicon.com/slkvcfos.json" trigger="loop" delay="1000"
                                colors="primary:#dc9f58,secondary:#dc9f58" style="width:30px;height:30px">
                            </lord-icon>
                        </button>
                    </li>
                    <li>
                        <img src="./image/material/plate.jpg">
                        <h3 class="item_name">雲朵盤叉組</h3>
                        <h3 class="item_id">(一組五人份)</h3>
                        $<p class="dollars">99</p>
                        <button class="moreItem_addCart">
                            <p>加入購物車</p>
                            <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>
                            <lord-icon src="https://cdn.lordicon.com/slkvcfos.json" trigger="loop" delay="1000"
                                colors="primary:#dc9f58,secondary:#dc9f58" style="width:30px;height:30px">
                            </lord-icon>
                        </button>

                    </li>
                    <li>
                        <a href="./item.html"><img src="./image/items/tart (5).jpg"></a>
                        <h3 class="item_name">Pistache tart</h3>
                        <h3 class="item_id">開心果塔</h3>
                        $<p class="dollars">160</p>
                        <button class="moreItem_addCart">
                            <p>加入購物車</p>
                            <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>
                            <lord-icon src="https://cdn.lordicon.com/slkvcfos.json" trigger="loop" delay="1000"
                                colors="primary:#dc9f58,secondary:#dc9f58" style="width:30px;height:30px">
                            </lord-icon>
                        </button>
                    </li>
                    <li>
                        <a href="./item.html"><img src="./image/items/mousse (5).jpg"></a>
                        <h3 class="item_name">Chocolate Cake</h3>
                        <h3 class="item_id">巧克力溜溜球蛋糕</h3>
                        $<p class="dollars">120</p>
                        <button class="moreItem_addCart">
                            <p>加入購物車</p>
                            <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>
                            <lord-icon clas="car_icon" src="https://cdn.lordicon.com/slkvcfos.json" trigger="loop"
                                delay="1000" colors="primary:#dc9f58,secondary:#dc9f58" style="width:30px;height:30px">
                            </lord-icon>
                        </button>
                    </li>
                    <li>
                        <a href="./item.html"><img src="./image/items/mousse (8).png">
                        </a>
                        <h3 class="item_name">Pistache Raspberry Mousse</h3>
                        <h3 class="item_id">開心果覆盆子慕斯</h3>
                        $<p class="dollars">190</p>
                        <button class="moreItem_addCart">
                            <p> 加入購物車</p>
                            <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>
                            <lord-icon clas="car_icon" src="https://cdn.lordicon.com/slkvcfos.json" trigger="loop"
                                delay="1000" colors="primary:#dc9f58,secondary:#dc9f58" style="width:30px;height:30px">
                            </lord-icon>
                        </button>
                    </li>
                </ul>

            </div>

            <!-- --------運送及付款方式/訂單資訊總結----------->
            <div class="order_inf">

                <!------左側運送資訊-------->
                <div class="delivery">
                    <p> 運送及付款方式</p>
                    <label for=""></label>
                    <div class="pickup">
                        <label for="pickup">取貨方式</label>
                        <select name="pickup" id="">
                            <option>門市自取</option>
                            <option>宅配</option>
                        </select>

                    </div>

                    <div class="pay">
                        <label for="pay">付款方式</label>
                        <select name="pay" id="">
                            <option>信用卡</option>
                            <option>LINE PAY</option>
                            <option>門市現金付款</option>
                        </select>

                    </div>

                    <!------※注意事項※----->
                    <div class="attention">
                        <h3>※注意事項※</h3>
                        <div class="content">
                            <p>※ 冷凍宅配運費一律$170，消費滿$1000免運費。</p>
                            <p>※ 我們宅配與黑貓宅急便配合運送，無法指定到貨日期。</p>
                            <p>※ 店面自取時間: 週一至週五11:30-19:00</p>
                            <p>※ 請確認購買商品與聯絡資訊正確無誤。</p>
                        </div>
                    </div>

                </div>

                <!------右側訂單資訊-------->
                <div class="check">
                    <p>訂單資訊</p>
                    <div class="money">
                        <div>
                            <p>合計:</p>
                            <p>$ <span id="summary">0</span></p>
                        </div>
                        <div>
                            <p>品項:</p>
                            <p>共 <span id="item_num">0</span> 樣</p>
                        </div>
                        <button>使用優惠券</button>
                        <div>
                            <p>折扣:</p>
                            <p>$ <span id="discount">50</span></p>
                        </div>
                        <div>
                            <p>運費:</p>
                            <p>$ <span id="delivery_fee">0</span></p>
                        </div>

                        <div class="sum">
                            <p>總金額:</p>
                            <p>$ <span id="sum">0</span></p>
                        </div>
                        <div class="buy">
                            <button type="button">確認結帳</button>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <!--手機才有的遮罩-->
        <div id="common_mask"></div>
    </main>

    <footer class="footer"></footer>

    <!-- -----------script------------- -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>


    <script src="./js/common.js"></script>
    <script>
        // -----------------------抓出localstorage商品並顯示--------------------------
        function get_items() {
            let items = JSON.parse(localStorage.getItem("car"));
            // console.log(items);

            if (items) {
                let list_html = ""; //

                items.forEach(function (item, i) {
                    // console.log(item);
                    list_html += `
                <ul class="car_item">
                    <li> <a href="./item.html"><img src="${get_img(item.item_id)}" alt=""></a></li>
                    <li class="item_name">${item.name}</li>
                    <li class="item_id">${item.item_id}</li>
                    <li class="dollars">${item.dollars}</li>
                    <li class="num">
                        <ul class="count">
                            <li><span id="num-decrease" class="num-count">－</span>
                            </li>
                            <li><input readonly disabled type="text" class="input-num" id="input-num" value="${item.num}"></input>
                            </li>
                            <li> <span id="num-jia" class="num-count">＋</span></li>
                        </ul>
                    </li>
                    <li class="total">${item.total}</li>
                    <li class="delete"><i class="fa-regular fa-circle-xmark"></i></li>
                 </ul> 
                <div class="mobile_delete">刪除</div>
                `;
                })


                $('.car_item_block').html(list_html);
                // let ul_task_list = document.getElementsByClassName("task_list")[0];
                // ul_task_list.innerHTML = list_html;
            }

        };

        // -----------------------刪除商品及localstorage--------------------------
        function delete_items() {
            //電腦版
            $('.fa-circle-xmark').click(function () {
                //取出ul
                let target_item_ul = $(this).closest('ul');
                //取出item_id
                let target_item = $(this).closest('ul').children('.item_id').html();

                //1 移除整條商品列，淡出1秒
                $(target_item_ul).addClass('fade_out');

                setTimeout(function () {
                    $(target_item_ul).remove()
                    calculate_sum();
                }, 500);


                //2 移除localstorage
                let tasks = JSON.parse(localStorage.getItem("car"));
                //不相同的要留下
                let updated_tasks = tasks.filter(function (item, i) {
                    return target_item != item.item_id;
                });
                // 回存至 localStorage
                localStorage.setItem("car", JSON.stringify(updated_tasks));

            })
            //手機板
            $('.mobile_delete').click(function () {
                //取出ul
                let target_item_ul = $(this).prev('ul');
                //取出item_id
                let target_item = $(this).prev('ul').children('.item_id').html();
                //1 移除整條商品列，淡出1秒
                $(target_item_ul).addClass('fade_out');
                setTimeout(function () {
                    $(target_item_ul).remove()
                    calculate_sum();
                }, 500);
                $(this).remove()

                //2 移除localstorage
                let tasks = JSON.parse(localStorage.getItem("car"));
                //不相同的要留下
                let updated_tasks = tasks.filter(function (item, i) {
                    return target_item != item.item_id;
                });
                // 回存至 localStorage
                localStorage.setItem("car", JSON.stringify(updated_tasks));


            })
        }

        //各商品數字加減
        function addition_items() {
            $('.num-count').click(function () {
                // 取得點擊那行的數量

                let num = $(this).closest('ul').find('.input-num').val();
                // let nums = parseInt(num) + 1;

                switch (this.id) {
                    case 'num-decrease':
                        if (num > 1) {
                            num--;
                        }
                        break;

                    case 'num-jia':
                        if (num < 10) {
                            num++;
                        }
                        break;
                }
                // console.log(num);


                // $(this).closest('li')
                // 塞入點擊那行的數量
                $(this).closest('ul').find('.input-num').val(num);

                // 取得點擊那行的金額
                let each_dollars = $(this).closest('.num').siblings(".dollars").html();
                // console.log(each_dollars);

                //取得點擊那行的總額 = 數量*金額
                let total = num * each_dollars;
                console.log(total);
                $(this).closest('.num').siblings('.total').html(total);

                //------------------新增資料至 localStorage--------------------
                let name = $(this).closest('.car_item').find('.item_name').html();
                let item_id = $(this).closest('.car_item').find('.item_id').html();

                let nums = this.id == 'num-jia' ? +1 : -1;
                let totals = nums * each_dollars;

                let item = {
                    "name": name,
                    "item_id": item_id,
                    "dollars": each_dollars,
                    "num": nums,
                    "total": totals
                };
                // console.log(item);

                addCar(item);
                calculate_sum()
            })
        }

        //加購商品加入購物車
        $('.moreItem_addCart').click(function () {
            //------------------第一步：新增資料至 localStorage--------------------
            let name = $(this).prevAll('.item_name').html();
            let item_id = $(this).prevAll('.item_id').html();
            let dollars = $(this).siblings('.dollars').html();
            let num = 1; //轉換成數字
            let total = dollars * num

            let item = {
                "name": name,
                "item_id": item_id,
                "dollars": dollars,
                "num": num,
                "total": total
            };
            addCar(item);

            //------------------第二步：取出資料顯示--------------------
            get_items();
            delete_items();
            addition_items();
            calculate_sum();

        })

        //執行
        $(function () {
            get_items();
            delete_items();
            addition_items();
        })

        //訂單資訊 計算總金額
        function calculate_sum() {
            // 合計
            let summary = 0;
            document.querySelectorAll('.total').forEach(function (li) {
                summary += parseInt(li.innerHTML);
            })
            document.getElementById('summary').innerHTML = summary;

            //各品項數量
            let item_num = $('.car_item_block').find('.car_item').length;
            console.log(item_num + "AA");

            document.getElementById('item_num').innerHTML = item_num;

            // 折扣
            let discount = document.getElementById('discount').innerHTML;

            // 算出是否需要運費170
            let total = summary - discount;
            console.log(total);

            if (total < 1000) {
                document.getElementById('delivery_fee').innerHTML = 170;
            } else {
                document.getElementById('delivery_fee').innerHTML = 0;

            }
            let delivery_fee = parseInt(document.getElementById('delivery_fee').innerHTML);

            //總金額
            let sum = summary - discount + delivery_fee;
            console.log(sum);
            document.getElementById('sum').innerHTML = sum;

        }
        $(function () {
            calculate_sum();
        })

    </script>
</body>

</html>